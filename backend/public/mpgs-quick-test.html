<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MPGS Quick Test</title>
    <style>
        body { font-family: Arial; margin: 20px; max-width: 600px; }
        .step { background: #f0f8ff; padding: 15px; margin: 15px 0; border-radius: 6px; }
        button { background: #1677ff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üîß MPGS Quick Test & Fix</h1>
    
    <div class="step">
        <h3>Step 1: Create Test Order</h3>
        <button onclick="createOrder()">Create Order</button>
        <div id="step1-result"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Open CORRECT Payment Page</h3>
        <p><strong>Use this URL format:</strong><br>
        <code>/api/payments/mpgs/payment/view?orders_id=YOUR_ORDER_ID</code></p>
        <button onclick="openCorrectPayment()" id="paymentBtn" disabled>Open Payment Page (Correct)</button>
        <div id="step2-result"></div>
    </div>
    
    <div class="step">
        <h3>‚ùå What NOT to do:</h3>
        <p>Don't open session URLs directly like:</p>
        <code style="color: red;">https://test-gateway.mastercard.com/checkout/version/73/merchant/.../session/...</code>
        <p><strong>These URLs are for checkout.js only!</strong></p>
    </div>

    <script>
        let currentOrderId = null;

        async function createOrder() {
            try {
                const response = await fetch('/api/payments/mpgs/create-test-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: '15.99', currency: 'USD' })
                });

                const data = await response.json();
                const resultDiv = document.getElementById('step1-result');

                if (data.success) {
                    currentOrderId = data.order.id;
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Order ${currentOrderId} created successfully!</div>`;
                    document.getElementById('paymentBtn').disabled = false;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Failed: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('step1-result').innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function openCorrectPayment() {
            if (!currentOrderId) {
                alert('Create an order first!');
                return;
            }

            const correctUrl = `/api/payments/mpgs/payment/view?orders_id=${currentOrderId}`;
            console.log('Opening correct payment URL:', correctUrl);
            
            // Open in new tab
            window.open(correctUrl, '_blank');
            
            document.getElementById('step2-result').innerHTML = 
                `<div class="result success">‚úÖ Opened payment page for order ${currentOrderId}<br>
                URL: <code>${correctUrl}</code></div>`;
        }
    </script>
</body>
</html>
